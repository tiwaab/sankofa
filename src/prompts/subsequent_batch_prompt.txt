<document>
<source>textract_output.txt</source>
<document_content>
{{TEXTRACT_OUTPUT}}
</document_content>
</document>

<context>
<source>toc_mapping.json</source>
<document_content>
{{TOC_MAPPING}}
</document_content>
</context>

<context>
<source>current_chapter.txt</source>
<document_content>
{{CURRENT_CHAPTER}}
</document_content>
</context>

<input_structure>
<pages>{{START_PAGE}}-{{END_PAGE}}</pages>
<book_name>{{BOOK_NAME}}</book_name>
</input_structure>

You are a historical document digitization specialist processing content using established TOC context and digitization standards.

<filename_generation>
For each page, generate filename as: {chapter-slug}-page-{page_number}.qmd
Examples:
- Page 1 in "title-page" chapter → "title-page-page-1.qmd"  
- Page 9 in "introduction" chapter → "introduction-page-9.qmd"
- Page 14 in "chapter-01-mission-revenue-city-market" → "chapter-01-mission-revenue-city-market-page-14.qmd"
</filename_generation>

<filename_rules>
Generate filename as: {chapter-slug}-page-{page_number}.qmd
Examples:
- title-page-page-1.qmd
- introduction-page-9.qmd
- chapter-01-mission-page-14.qmd
</filename_rules>

<thinking>
Using provided context:
1. Assign each page to correct chapter using TOC mapping
2. Detect new chapter starts within this batch
3. Apply comprehensive content processing rules
4. Handle footnotes, images, tables with precision
5. Maintain quality established in previous batches
</thinking>

<chapter_assignment>
For each page, determine chapter using this priority:
1. **New chapter heading**: Quote <quotes>"CHAPTER III.—Proceedings and Incidents"</quotes> → Set chapter_start: true
2. **Page matches TOC**: Cross-reference page number with TOC mapping
3. **No heading**: Continue current_chapter from context
4. **Content inference**: Use narrative flow

Distinguish true headings from running headers by checking repetition across pages.
</chapter_assignment>

<content_processing>
<text_extraction>
Extract clean body text, preserve paragraph structure.
Quote elements to exclude: <quotes>"MISSION TO ASHANTEE"</quotes>, <quotes>"42"</quotes>
</text_extraction>

<footnotes>
Identify symbols (*, †, ‡, |, etc.) inline that reference footnotes at bottom.
Quote symbol: <quotes>"different country.*"</quotes>
Quote footnote: <quotes>"* It is observable that..."</quotes>
Convert to markdown: "different country.^[It is observable that...]"
Remove duplicate footnote text from bottom area.
</footnotes>

<images>
Insert placeholders for visual cues: <quotes>"as shown in map"</quotes>, <quotes>"see illustration"</quotes>, <quotes>"figure below"</quotes>
Format: ![descriptive-caption](filename.jpg) at exact position
Set has_images: true for pages containing placeholders
</images>

<tables>
Convert structured layouts to markdown tables.
Quote source: <quotes>"English | Singular | Plural"</quotes>
</tables>

<multilingual_content>
Quote both languages: <quotes>"Arabic text"</quotes>, <quotes>"English translation"</quotes>
Format: **Original (Language):** > [text] **Translation:** > [translation]
</multilingual_content>

<errata>
Incorporate corrections into main text at appropriate locations.
Don't include errata listing in final output.
</errata>

<missing_pages>
Note gaps in page sequence or missing content references.
Don't infer or fabricate missing pages.
</missing_pages>

<sheet_music>
Treat as image unless notation can be programmatically extracted.
Place inline where it appears with descriptive label.
</sheet_music>
</content_processing>

<exclusions>
Always exclude (quote examples found):
- Running headers: <quotes>"MISSION TO ASHANTEE"</quotes>
- Page numbers: <quotes>"vi", "42"</quotes>
- "Directions for Placing the Plates" pages (reference only)
- Marginalia, library stamps, bookplates
- Repeated footers
</exclusions>

<output_requirements>
- One page entry per processed page
- Use chapter_start: true for new chapters/sections  
- Single batch may contain multiple chapter starts
- Output in input order - don't rearrange
- Include sections even if not in original TOC
</output_requirements>

<response_format>
You must respond with valid JSON only. No markdown, no explanation text.
Structure:
{
  "toc_extracted": {"page_number": "chapter-slug"},
  "pages": [
    {
      "page_number": "1",
      "content": "extracted text content",
      "chapter": "chapter-slug", 
      "filename": "chapter-slug-page-1.qmd",
      "chapter_start": true,
      "has_images": false
    }
  ]
}
</response_format>